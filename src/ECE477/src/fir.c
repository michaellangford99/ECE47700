#include "stm32f4xx.h"
#include "string.h"
#include "systick.h"
#include "math.h"
#include "fir.h"

const float hanning_8[8] = {
	0,
	0.1883,
	0.6113,
	0.9505,
	0.9505,
	0.6113,
	0.1883,
	0
};

const float hanning_64[64] = {
        0,
   0.0025,
   0.0099,
   0.0222,
   0.0393,
   0.0609,
   0.0869,
   0.1170,
   0.1509,
   0.1883,
   0.2287,
   0.2719,
   0.3173,
   0.3646,
   0.4132,
   0.4626,
   0.5125,
   0.5622,
   0.6113,
   0.6592,
   0.7056,
   0.7500,
   0.7919,
   0.8308,
   0.8665,
   0.8986,
   0.9266,
   0.9505,
   0.9698,
   0.9845,
   0.9944,
   0.9994,
   0.9994,
   0.9944,
   0.9845,
   0.9698,
   0.9505,
   0.9266,
   0.8986,
   0.8665,
   0.8308,
   0.7919,
   0.7500,
   0.7056,
   0.6592,
   0.6113,
   0.5622,
   0.5125,
   0.4626,
   0.4132,
   0.3646,
   0.3173,
   0.2719,
   0.2287,
   0.1883,
   0.1509,
   0.1170,
   0.0869,
   0.0609,
   0.0393,
   0.0222,
   0.0099,
   0.0025,
        0
        };

const float hanning_256[256] = {
	0,
	0.00015177f,
	0.000607f,
	0.0013654f,
	0.0024265f,
	0.0037897f,
	0.0054542f,
	0.0074189f,
	0.0096826f,
	0.012244f,
	0.015102f,
	0.018253f,
	0.021698f,
	0.025433f,
	0.029455f,
	0.033764f,
	0.038355f,
	0.043227f,
	0.048376f,
	0.0538f,
	0.059494f,
	0.065456f,
	0.071681f,
	0.078166f,
	0.084908f,
	0.091902f,
	0.099143f,
	0.10663f,
	0.11435f,
	0.12231f,
	0.1305f,
	0.13891f,
	0.14754f,
	0.15638f,
	0.16543f,
	0.17469f,
	0.18414f,
	0.19379f,
	0.20362f,
	0.21363f,
	0.22382f,
	0.23417f,
	0.24468f,
	0.25535f,
	0.26617f,
	0.27713f,
	0.28823f,
	0.29945f,
	0.31079f,
	0.32225f,
	0.33382f,
	0.34549f,
	0.35725f,
	0.3691f,
	0.38103f,
	0.39303f,
	0.4051f,
	0.41722f,
	0.4294f,
	0.44161f,
	0.45387f,
	0.46615f,
	0.47845f,
	0.49076f,
	0.50308f,
	0.5154f,
	0.52771f,
	0.54f,
	0.55226f,
	0.5645f,
	0.5767f,
	0.58885f,
	0.60094f,
	0.61298f,
	0.62494f,
	0.63683f,
	0.64864f,
	0.66036f,
	0.67197f,
	0.68349f,
	0.69489f,
	0.70618f,
	0.71734f,
	0.72837f,
	0.73926f,
	0.75f,
	0.76059f,
	0.77103f,
	0.7813f,
	0.7914f,
	0.80132f,
	0.81106f,
	0.82061f,
	0.82996f,
	0.83912f,
	0.84807f,
	0.85681f,
	0.86533f,
	0.87363f,
	0.8817f,
	0.88954f,
	0.89714f,
	0.90451f,
	0.91163f,
	0.91849f,
	0.92511f,
	0.93146f,
	0.93756f,
	0.94339f,
	0.94895f,
	0.95423f,
	0.95924f,
	0.96398f,
	0.96843f,
	0.97259f,
	0.97647f,
	0.98006f,
	0.98336f,
	0.98636f,
	0.98907f,
	0.99149f,
	0.9936f,
	0.99542f,
	0.99693f,
	0.99814f,
	0.99905f,
	0.99966f,
	0.99996f,
	0.99996f,
	0.99966f,
	0.99905f,
	0.99814f,
	0.99693f,
	0.99542f,
	0.9936f,
	0.99149f,
	0.98907f,
	0.98636f,
	0.98336f,
	0.98006f,
	0.97647f,
	0.97259f,
	0.96843f,
	0.96398f,
	0.95924f,
	0.95423f,
	0.94895f,
	0.94339f,
	0.93756f,
	0.93146f,
	0.92511f,
	0.91849f,
	0.91163f,
	0.90451f,
	0.89714f,
	0.88954f,
	0.8817f,
	0.87363f,
	0.86533f,
	0.85681f,
	0.84807f,
	0.83912f,
	0.82996f,
	0.82061f,
	0.81106f,
	0.80132f,
	0.7914f,
	0.7813f,
	0.77103f,
	0.76059f,
	0.75f,
	0.73926f,
	0.72837f,
	0.71734f,
	0.70618f,
	0.69489f,
	0.68349f,
	0.67197f,
	0.66036f,
	0.64864f,
	0.63683f,
	0.62494f,
	0.61298f,
	0.60094f,
	0.58885f,
	0.5767f,
	0.5645f,
	0.55226f,
	0.54f,
	0.52771f,
	0.5154f,
	0.50308f,
	0.49076f,
	0.47845f,
	0.46615f,
	0.45387f,
	0.44161f,
	0.4294f,
	0.41722f,
	0.4051f,
	0.39303f,
	0.38103f,
	0.3691f,
	0.35725f,
	0.34549f,
	0.33382f,
	0.32225f,
	0.31079f,
	0.29945f,
	0.28823f,
	0.27713f,
	0.26617f,
	0.25535f,
	0.24468f,
	0.23417f,
	0.22382f,
	0.21363f,
	0.20362f,
	0.19379f,
	0.18414f,
	0.17469f,
	0.16543f,
	0.15638f,
	0.14754f,
	0.13891f,
	0.1305f,
	0.12231f,
	0.11435f,
	0.10663f,
	0.099143f,
	0.091902f,
	0.084908f,
	0.078166f,
	0.071681f,
	0.065456f,
	0.059494f,
	0.0538f,
	0.048376f,
	0.043227f,
	0.038355f,
	0.033764f,
	0.029455f,
	0.025433f,
	0.021698f,
	0.018253f,
	0.015102f,
	0.012244f,
	0.0096826f,
	0.0074189f,
	0.0054542f,
	0.0037897f,
	0.0024265f,
	0.0013654f,
	0.000607f,
	0.00015177f,
	0
};

float compute_filter(struct fir_filter* f)
{
	float conv_sum = 0.0f;

	for (int i = 0; i < f->length; i++)
	{
		conv_sum += f->impulse_response[i] * f->circular_buffer[(f->first_element + i) % f->length];
	}

	return conv_sum/((f->length-1)/2.0f);
}

float update_filter(struct fir_filter* f, float new_value)
{
	shift_filter(f, &new_value, 1);

	return compute_filter(f);
}

void shift_filter(struct fir_filter* f, float* new_values, int count)
{
	for (int i = 0; i < count; i++)
	{
		f->circular_buffer[f->first_element] = new_values[i];
		f->first_element++;
		f->first_element = f->first_element%f->length;
	}
}
